const TelegramBot = require('node-telegram-bot-api');
const PhotoHandler = require('./handlers/photoHandler');
const MessageHandler = require('./handlers/messageHandler');

class BotManager {
  constructor(config) {
    this.config = config;
    this.bot = null;
    this.handlers = {};
    
    this.init();
  }

  init() {
    try {
      console.log('üö¶ Initialisation du bot LR ASSIST...');
      
      // Cr√©er l'instance du bot
      if (this.config.telegram.webhookUrl) {
        this.bot = new TelegramBot(this.config.telegram.token, {
          webHook: {
            port: process.env.BOT_PORT || 8443
          },
          parse_mode: 'Markdown'
        });
        // Enregistrement automatique du webhook
        this.bot.setWebHook(this.config.telegram.webhookUrl + '/bot' + this.config.telegram.token)
          .then(() => {
            console.log('üåê Webhook Telegram enregistr√© automatiquement :', this.config.telegram.webhookUrl);
          })
          .catch(err => {
            console.error('‚ùå Erreur enregistrement webhook Telegram :', err.message);
          });
        console.log('üåê Bot Telegram d√©marr√© en mode webhook:', this.config.telegram.webhookUrl);
      } else {
        this.bot = new TelegramBot(this.config.telegram.token, {
          polling: true,
          parse_mode: 'Markdown'
        });
        console.log('ü§ñ Bot Telegram d√©marr√© en mode polling');
      }

      // G√©rer les erreurs de polling
      this.bot.on('polling_error', (error) => {
        if (error.code === 'ETELEGRAM' && error.response.body.error_code === 409) {
          console.log('‚ö†Ô∏è Une autre instance du bot est d√©j√† en cours d\'ex√©cution.');
        } else {
          console.error('‚ùå Erreur polling Telegram:', error);
        }
      });

      // Initialiser les handlers
      this.initHandlers();
      
      // Initialiser les handlers de base
      this.initBaseHandlers();
      
      console.log('‚úÖ Bot LR ASSIST initialis√© avec succ√®s');
      
    } catch (error) {
      console.error('‚ùå Erreur initialisation bot:', error);
      throw error;
    }
  }

  initHandlers() {
    // Initialiser le handler photo
    this.handlers.photo = new PhotoHandler(this.bot, this.config);
    
    // Initialiser le handler message
    this.handlers.message = new MessageHandler(this.bot, this.config);
    
    console.log('üìã Handlers initialis√©s');
  }

  initBaseHandlers() {
    // Handler pour /start
    this.bot.onText(/\/start/, (msg) => {
      this.handleStart(msg);
    });

    // Handler pour les boutons du menu
    this.bot.on('message', (msg) => {
      if (msg.text) {
        this.handleMenuButton(msg);
      }
    });

    // Handler pour les callback queries (checklist)
    this.bot.on('callback_query', (query) => {
      this.handleCallbackQuery(query);
    });

    console.log('üîß Handlers de base initialis√©s');
  }

  async handleStart(msg) {
    const chatId = msg.chat.id;
    const userId = msg.from.id.toString();
    const userName = msg.from.first_name || 'Utilisateur';
    
    console.log(`üëã Nouvel utilisateur: ${userName} (${userId})`);
    
    const welcome = `üö¶ *Bienvenue sur LR ASSIST*\n\n` +
      `Je suis votre assistant ferroviaire intelligent.\n\n` +
      `üì∏ Envoyez des photos pour documentation\n` +
      `üìç Partagez votre position GPS\n` +
      `üö® Signalez des urgences\n` +
      `üìã Suivez les checklists de s√©curit√©\n\n` +
      `Utilisez le menu ci-dessous üëá`;

    const mainMenu = {
      reply_markup: {
        keyboard: [
          ['üì∏ Envoyer Photo', 'üìç Partager Position'],
          ['üö® Alerte Urgence', 'üìã Checklist'],
          ['üîç Portail Acc√®s', 'üìä Historique'],
          ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
        ],
        resize_keyboard: true
      }
    };

    await this.bot.sendMessage(chatId, welcome, mainMenu);
  }

  async handleMenuButton(msg) {
    const chatId = msg.chat.id;
    const text = msg.text;

    switch (text) {
      case 'üì∏ Envoyer Photo':
        await this.bot.sendMessage(chatId, 'üì∏ Envoie ta photo directement ici. Elle sera sauvegard√©e avec m√©tadonn√©es.');
        break;
        
      case 'üìç Partager Position':
        await this.bot.sendMessage(chatId, 'üìç Clique pour envoyer ta position GPS. Le PK SNCF sera calcul√© automatiquement üëá', {
          reply_markup: {
            keyboard: [[{ text: 'üìç Partager ma position', request_location: true }]],
            resize_keyboard: true
          }
        });
        break;
        
      case 'üö® Alerte Urgence':
        await this.handleEmergency(chatId, msg.from.first_name || 'Utilisateur', msg.from.id.toString());
        break;
        
      case 'üìã Checklist':
        await this.sendChecklist(chatId);
        break;
        
      case 'üîç Portail Acc√®s':
        await this.findNearestAccessPortal(chatId, msg.from.first_name || 'Utilisateur', msg.from.id.toString());
        break;
        
      case 'üìä Historique':
        await this.sendHistory(chatId, msg.from.id.toString());
        break;
        
      case '‚öôÔ∏è Param√®tres':
        await this.sendSettings(chatId);
        break;
        
      case '‚ùì Aide':
        await this.sendHelp(chatId);
        break;
        
      default:
        // Les autres messages sont trait√©s par le MessageHandler
        break;
    }
  }

  async handleCallbackQuery(query) {
    const chatId = query.message.chat.id;
    const userId = query.from.id.toString();
    const userName = query.from.first_name || 'Utilisateur';
    const data = query.data;

    try {
      if (data.startsWith('check')) {
        const step = parseInt(data.replace('check', ''));
        const steps = [
          { label: 'Position train v√©rifi√©e', callback_data: 'check1' },
          { label: 'Chef chantier contact√©', callback_data: 'check2' },
          { label: 'Signalisations activ√©es', callback_data: 'check3' },
          { label: 'Circulation voie bloqu√©e', callback_data: 'check4' },
          { label: 'Mise hors voie confirm√©e', callback_data: 'check5' }
        ];

        if (step >= 1 && step <= steps.length) {
          await this.bot.answerCallbackQuery(query.id, { text: `‚úÖ ${steps[step-1].label}` });
          
          // Mettre √† jour le message avec le statut
          const updatedText = query.message.text + `\n‚úÖ ${steps[step-1].label}`;
          await this.bot.editMessageText(updatedText, {
            chat_id: chatId,
            message_id: query.message.message_id
          });
        }
      }
    } catch (error) {
      console.error('‚ùå Erreur callback query:', error);
      await this.bot.answerCallbackQuery(query.id, { text: "‚ùå Erreur" });
    }
  }

  async handleEmergency(chatId, userName, userId) {
    try {
      // R√©cup√©rer la derni√®re position connue
      const data = this.handlers.photo.loadData();
      const lastLocation = data.locations.find(loc => loc.userId === userId);
      
      if (lastLocation) {
        const alertMsg = `üö® *ALERTE D'URGENCE*\n\n` +
          `üë§ Op√©rateur: ${userName}\n` +
          `üÜî ID: ${userId}\n` +
          `üìç Position: ${lastLocation.latitude}, ${lastLocation.longitude}\n` +
          `üö¶ PK SNCF: ${lastLocation.pkSNCF}\n` +
          `üõ§Ô∏è Ligne: ${lastLocation.lineName}\n` +
          `üïê Horodatage: ${new Date().toLocaleString('fr-FR')}\n\n` +
          `‚ö†Ô∏è Intervention requise imm√©diatement`;

        await this.bot.sendMessage(this.config.telegram.adminChatId, alertMsg, {
          parse_mode: 'Markdown'
        });

        await this.bot.sendMessage(chatId, "üö® Alerte d'urgence envoy√©e aux administrateurs\n\nVotre position a √©t√© transmise. Restez en s√©curit√©.", {
          reply_markup: {
            keyboard: [
              ['üì∏ Envoyer Photo', 'üìç Partager Position'],
              ['üö® Alerte Urgence', 'üìã Checklist'],
              ['üîç Portail Acc√®s', 'üìä Historique'],
              ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
            ],
            resize_keyboard: true
          }
        });
      } else {
        await this.bot.sendMessage(chatId, "‚ùå ERREUR CRITIQUE - Votre position n'est pas connue. Envoyez imm√©diatement votre position GPS pour la mise hors voie d'urgence.", {
          reply_markup: {
            keyboard: [[{ text: 'üìç Partager ma position', request_location: true }]],
            resize_keyboard: true
          }
        });
      }
    } catch (error) {
      console.error('‚ùå Erreur alerte urgence:', error);
      await this.bot.sendMessage(chatId, "‚ùå Erreur lors de l'envoi de l'alerte. Contactez directement les secours.", {
        reply_markup: {
          keyboard: [
            ['üì∏ Envoyer Photo', 'üìç Partager Position'],
            ['üö® Alerte Urgence', 'üìã Checklist'],
            ['üîç Portail Acc√®s', 'üìä Historique'],
            ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
          ],
          resize_keyboard: true
        }
      });
    }
  }

  async sendChecklist(chatId) {
    const keyboard = [
      [{ text: "‚ùå V√©rifier position train", callback_data: 'check1' }],
      [{ text: "‚ùå Contacter chef chantier", callback_data: 'check2' }],
      [{ text: "‚ùå Activer signalisations", callback_data: 'check3' }],
      [{ text: "‚ùå Bloquer circulation voie", callback_data: 'check4' }],
      [{ text: "‚ùå Confirmer mise hors voie", callback_data: 'check5' }]
    ];
    
    await this.bot.sendMessage(chatId, "‚úÖ Checklist de s√©curit√© ferroviaire :", {
      reply_markup: { inline_keyboard: keyboard }
    });
  }

  async findNearestAccessPortal(chatId, userName, userId) {
    try {
      const data = this.handlers.photo.loadData();
      const lastLocation = data.locations.find(loc => loc.userId === userId);
      
      if (lastLocation) {
        // Ici vous pouvez int√©grer la logique de recherche de portail
        const pkMsg = `PK ${lastLocation.pkSNCF} (${lastLocation.lineName})`;
        const portalMsg = `Portail d'acc√®s le plus proche: [√Ä impl√©menter]`;
        
        await this.bot.sendMessage(chatId, `üìç Depuis votre position :\n${pkMsg}\n\n${portalMsg}`, {
          reply_markup: {
            keyboard: [
              ['üì∏ Envoyer Photo', 'üìç Partager Position'],
              ['üö® Alerte Urgence', 'üìã Checklist'],
              ['üîç Portail Acc√®s', 'üìä Historique'],
              ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
            ],
            resize_keyboard: true
          }
        });
      } else {
        await this.bot.sendMessage(chatId, "‚ùå Votre position n'est pas connue. Envoyez d'abord votre position GPS.", {
          reply_markup: {
            keyboard: [
              ['üì∏ Envoyer Photo', 'üìç Partager Position'],
              ['üö® Alerte Urgence', 'üìã Checklist'],
              ['üîç Portail Acc√®s', 'üìä Historique'],
              ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
            ],
            resize_keyboard: true
          }
        });
      }
    } catch (error) {
      console.error('‚ùå Erreur recherche portail:', error);
      await this.bot.sendMessage(chatId, "‚ùå Erreur lors de la recherche du portail d'acc√®s.", {
        reply_markup: {
          keyboard: [
            ['üì∏ Envoyer Photo', 'üìç Partager Position'],
            ['üö® Alerte Urgence', 'üìã Checklist'],
            ['üîç Portail Acc√®s', 'üìä Historique'],
            ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
          ],
          resize_keyboard: true
        }
      });
    }
  }

  async sendHistory(chatId, userId) {
    try {
      const data = this.handlers.photo.loadData();
      const userMessages = data.messages.filter(msg => msg.userId === userId).slice(-5);
      
      if (userMessages.length > 0) {
        let historyMsg = "üìä Vos 5 derni√®res actions :\n\n";
        userMessages.forEach((msg, index) => {
          const date = new Date(msg.timestamp).toLocaleString('fr-FR');
          historyMsg += `${index + 1}. ${msg.message} (${date})\n`;
        });
        
        await this.bot.sendMessage(chatId, historyMsg, {
          reply_markup: {
            keyboard: [
              ['üì∏ Envoyer Photo', 'üìç Partager Position'],
              ['üö® Alerte Urgence', 'üìã Checklist'],
              ['üîç Portail Acc√®s', 'üìä Historique'],
              ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
            ],
            resize_keyboard: true
          }
        });
      } else {
        await this.bot.sendMessage(chatId, "üìä Aucun historique disponible.", {
          reply_markup: {
            keyboard: [
              ['üì∏ Envoyer Photo', 'üìç Partager Position'],
              ['üö® Alerte Urgence', 'üìã Checklist'],
              ['üîç Portail Acc√®s', 'üìä Historique'],
              ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
            ],
            resize_keyboard: true
          }
        });
      }
    } catch (error) {
      console.error('‚ùå Erreur historique:', error);
      await this.bot.sendMessage(chatId, "‚ùå Erreur lors de la r√©cup√©ration de l'historique.", {
        reply_markup: {
          keyboard: [
            ['üì∏ Envoyer Photo', 'üìç Partager Position'],
            ['üö® Alerte Urgence', 'üìã Checklist'],
            ['üîç Portail Acc√®s', 'üìä Historique'],
            ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
          ],
          resize_keyboard: true
        }
      });
    }
  }

  async sendSettings(chatId) {
    const settingsMsg = `‚öôÔ∏è *Param√®tres*\n\n` +
      `üîî Notifications: Activ√©es\n` +
      `üì∏ Qualit√© photo: Haute\n` +
      `üìç Pr√©cision GPS: √âlev√©e\n` +
      `üïê Fuseau horaire: Europe/Paris\n\n` +
      `*Statut:* Op√©rationnel`;

    await this.bot.sendMessage(chatId, settingsMsg, {
      parse_mode: 'Markdown',
      reply_markup: {
        keyboard: [
          ['üì∏ Envoyer Photo', 'üìç Partager Position'],
          ['üö® Alerte Urgence', 'üìã Checklist'],
          ['üîç Portail Acc√®s', 'üìä Historique'],
          ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
        ],
        resize_keyboard: true
      }
    });
  }

  async sendHelp(chatId) {
    const helpMsg = `‚ùì *Aide LR ASSIST*\n\n` +
      `üì∏ *Photos* : Envoyez des photos pour documentation\n` +
      `üìç *Position* : Partagez votre position GPS\n` +
      `üö® *Urgence* : Signalez une situation d'urgence\n` +
      `üìã *Checklist* : Suivez les proc√©dures de s√©curit√©\n` +
      `üîç *Portail* : Trouvez le portail d'acc√®s le plus proche\n` +
      `üìä *Historique* : Consultez vos actions r√©centes\n\n` +
      `*Commandes disponibles:*\n` +
      `/start - Menu principal\n` +
      `/help - Cette aide\n` +
      `/status - Statut du syst√®me`;

    await this.bot.sendMessage(chatId, helpMsg, {
      parse_mode: 'Markdown',
      reply_markup: {
        keyboard: [
          ['üì∏ Envoyer Photo', 'üìç Partager Position'],
          ['üö® Alerte Urgence', 'üìã Checklist'],
          ['üîç Portail Acc√®s', 'üìä Historique'],
          ['‚öôÔ∏è Param√®tres', '‚ùì Aide']
        ],
        resize_keyboard: true
      }
    });
  }

  stop() {
    if (this.bot) {
      console.log('üõë Arr√™t du bot LR ASSIST...');
      this.bot.stopPolling();
    }
  }

  getBot() {
    return this.bot;
  }

  getHandlers() {
    return this.handlers;
  }
}

module.exports = BotManager; 