<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ENCO Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="bg-gradient-to-br from-blue-900 to-blue-400 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-blue-800 text-white flex flex-col items-center py-8">
    <img src="https://img.icons8.com/ios-filled/100/ffffff/inspection.png" alt="ENCO" class="w-24 h-24 rounded-full mb-4 border-4 border-white shadow-lg">
    <h1 class="text-2xl font-bold mb-8">ENCO</h1>
    <nav class="flex flex-col gap-4 w-full px-6">
      <a href="#" class="py-2 px-4 rounded bg-blue-700 font-semibold">Carte</a>
      <a href="#" class="py-2 px-4 rounded hover:bg-blue-700">Historique</a>
      <a href="#" class="py-2 px-4 rounded hover:bg-blue-700">Documents</a>
      <a href="#" class="py-2 px-4 rounded hover:bg-blue-700">Statistiques</a>
    </nav>
  </aside>
  <!-- Main content -->
  <main class="flex-1 p-10">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-3xl font-bold">Carte des Opérateurs <span id="status" class="ml-4 text-green-500 text-lg">● Système opérationnel</span></h2>
      <button onclick="refreshAll()" class="bg-blue-600 text-white px-4 py-2 rounded shadow">🔄 Actualiser</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
      <div class="bg-gradient-to-br from-blue-600 to-purple-500 rounded-xl p-8 shadow text-white">
        <h3 class="text-xl font-bold mb-2">👥 Opérateurs</h3>
        <div id="total-ops" class="text-4xl font-extrabold">0</div>
        <div class="text-sm">Total enregistrés</div>
      </div>
      <div class="bg-gradient-to-br from-blue-600 to-purple-500 rounded-xl p-8 shadow text-white">
        <h3 class="text-xl font-bold mb-2">🟢 En ligne</h3>
        <div id="online-ops" class="text-4xl font-extrabold">0</div>
        <div class="text-sm">Actuellement en poste</div>
      </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="text-xl font-bold mb-4">🗺️ Carte des Opérateurs ENCO</h3>
      <div id="map" class="w-full h-[500px] rounded"></div>
    </div>
  </main>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map, markersLayer;
    function initMap() {
      map = L.map('map').setView([47, 2], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }
    async function refreshAll() {
      // Ping l'API pour signaler l'activité (simulateur)
      await fetch('/api/ping', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: 'dashboard', userName: 'Dashboard' })
      });
      // Récupère les stats opérateurs
      const res = await fetch('/api/operators');
      const operators = await res.json();
      document.getElementById('total-ops').textContent = operators.length;
      const online = operators.filter(op => op.online);
      document.getElementById('online-ops').textContent = online.length;
      // Affiche les opérateurs sur la carte
      markersLayer.clearLayers();
      operators.forEach(op => {
        if(op.lastPing && op.latitude && op.longitude) {
          const marker = L.marker([op.latitude, op.longitude]).addTo(markersLayer);
          marker.bindPopup(`<b>${op.userName || op.userId}</b><br>Dernier ping: ${new Date(op.lastPing).toLocaleString('fr-FR')}`);
        }
      });
    }
    window.onload = () => {
      initMap();
      refreshAll();
    };
  </script>
</body>
</html> 